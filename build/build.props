<Project>

  <!-- Use build number from CI if available -->
  <PropertyGroup Condition=" '$(BuildNumber)' == '' ">
    <BuildNumber Condition=" '$(BUILD_NUMBER)' != '' ">$(BUILD_NUMBER)</BuildNumber>
    <BuildNumber Condition=" '$(APPVEYOR_BUILD_NUMBER)' != '' ">$(APPVEYOR_BUILD_NUMBER)</BuildNumber>
  </PropertyGroup>
  
  <PropertyGroup>
    <VersionSuffix Condition="'$(VersionSuffix)' != '' AND '$(BuildNumber)' != ''">$(VersionSuffix)-$(BuildNumber)</VersionSuffix>
  </PropertyGroup>
  
  <Target Name="AddAssemblyMetadata" BeforeTargets="CoreCompile" Condition=" '$(CI)' != '' ">    
    <Message Text="Build server configuration detected, setting Assembly metadata attributes..." />
    
    <ItemGroup Condition=" '$(CSG_SVNREV)' != '' ">
      <AssemblyAttributes Include="AssemblyMetadata">
        <_Parameter1>BuildDate</_Parameter1>
        <_Parameter2>$(CSG_BUILDDATE)</_Parameter2>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyMetadata" Condition=" '$(CSG_SVNREV)' != ''">
        <_Parameter1>SvnRevision</_Parameter1>
        <_Parameter2>$(CSG_SVNREV)</_Parameter2>
      </AssemblyAttributes>
    </ItemGroup>
    
    <ItemGroup Condition=" '$(BuildNumber)' != '' ">
      <AssemblyAttributes Include="AssemblyMetadata">
        <_Parameter1>CommitHash</_Parameter1>
        <_Parameter2>$(CommitHash)</_Parameter2>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyMetadata">
        <_Parameter1>BuildNumber</_Parameter1>
        <_Parameter2>$(BuildNumber)</_Parameter2>
      </AssemblyAttributes>
    </ItemGroup>
    
    <Touch Files="obj\GeneratedAssemblyInfo.cs" AlwaysCreate="true"/>
    
    <WriteCodeFragment Language="C#" OutputFile="obj\GeneratedAssemblyInfo.cs" AssemblyAttributes="@(AssemblyAttributes)" />
    
    <ItemGroup>
      <Compile Include="obj\GeneratedAssemblyInfo.cs" />
    </ItemGroup>
    
  </Target>
  
</Project>